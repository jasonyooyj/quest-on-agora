generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model exam_nodes {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instructor_id    String
  parent_id        String?      @db.Uuid
  kind             String
  name             String
  sort_order       Int          @default(0)
  exam_id          String?      @db.Uuid
  created_at       DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?    @default(now()) @db.Timestamptz(6)
  exams            exams?       @relation(fields: [exam_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  exam_nodes       exam_nodes?  @relation("exam_nodesToexam_nodes", fields: [parent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  other_exam_nodes exam_nodes[] @relation("exam_nodesToexam_nodes")

  @@index([exam_id], map: "idx_exam_nodes_exam_id")
  @@index([instructor_id], map: "idx_exam_nodes_instructor_id")
  @@index([kind], map: "idx_exam_nodes_kind")
  @@index([parent_id], map: "idx_exam_nodes_parent_id")
  @@index([parent_id, sort_order], map: "idx_exam_nodes_sort_order")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model exams {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  code          String       @unique
  description   String?
  duration      Int
  questions     Json
  status        String?      @default("draft")
  instructor_id String
  student_count Int?         @default(0)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?    @default(now()) @db.Timestamptz(6)
  materials     Json?        @default("[]")
  rubric        Json?        @default("[]")
  exam_nodes    exam_nodes[]

  @@index([code], map: "idx_exams_code")
  @@index([instructor_id], map: "idx_exams_instructor_id")
  @@index([rubric], map: "idx_exams_rubric", type: Gin)
}

model grades {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id    String   @db.Uuid
  q_idx         Int
  score         Int
  comment       String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  stage_grading Json?
  sessions      sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model messages {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id           String   @db.Uuid
  q_idx                Int
  role                 String
  content              String
  created_at           DateTime @default(now()) @db.Timestamptz(6)
  compressed_content   String?
  compression_metadata Json?    @default("{}")
  response_id          String?  // OpenAI Responses API response ID for chaining conversations
  message_type         String?  // 질문 타입: "concept" | "calculation" | "strategy" | "other"
  tokens_used          Int?     // 토큰 사용량 (prompt + completion)
  metadata             Json?    @default("{}") // 추가 메타데이터 (토큰 상세 정보 등)
  sessions             sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model questions {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exam_id    String   @db.Uuid
  idx        Int
  type       String
  prompt     String
  ai_context String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model sessions {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exam_id                 String        @db.Uuid
  student_id              String
  used_clarifications     Int           @default(0)
  created_at              DateTime      @default(now()) @db.Timestamptz(6)
  submitted_at            DateTime?     @db.Timestamptz(6)
  compressed_session_data String?
  compression_metadata    Json?         @default("{}")
  ai_summary              Json?         // AI 자동 채점 요약 평가
  grades                  grades[]
  messages                messages[]
  submissions             submissions[]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model submissions {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id               String   @db.Uuid
  q_idx                    Int
  answer                   String
  ai_feedback              Json?
  student_reply            String?
  created_at               DateTime @default(now()) @db.Timestamptz(6)
  updated_at               DateTime? @default(now()) @db.Timestamptz(6) // 답안 수정 시간
  answer_history           Json?    @default("[]") // 답안 수정 이력: [{ text: string, timestamp: string }]
  edit_count               Int?     @default(0) // 답안 수정 횟수
  compressed_answer_data   String?
  compressed_feedback_data String?
  compression_metadata     Json?    @default("{}")
  sessions                 sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// Student profile information
model student_profiles {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id String   @unique // Clerk user ID
  name       String   // 학생 이름
  student_number String // 학번
  school     String   // 학교명
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([student_id], map: "idx_student_profiles_student_id")
}

/// Discussion session for class debates
model discussion_sessions {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instructor_id   String   // Clerk user ID of the instructor
  title           String   // Discussion topic/title
  description     String?  // Detailed description
  status          String   @default("draft") // "draft" | "active" | "closed"
  join_code       String   @unique // Short code for students to join
  settings        Json     @default("{}") // { anonymous: boolean, stanceOptions: string[], endTime?: string }
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  closed_at       DateTime? @db.Timestamptz(6)
  participants    discussion_participants[]
  messages        discussion_messages[]
  pinned_quotes   discussion_pinned_quotes[]

  @@index([instructor_id], map: "idx_discussion_sessions_instructor_id")
  @@index([join_code], map: "idx_discussion_sessions_join_code")
  @@index([status], map: "idx_discussion_sessions_status")
}

/// Participants in a discussion session
model discussion_participants {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id      String   @db.Uuid
  student_id      String   // Clerk user ID
  display_name    String?  // For anonymous mode: "Student 12"
  stance          String?  // "pro" | "con" | "neutral" | null (unsubmitted)
  stance_statement String? // Final statement for their stance
  evidence_1      String?  // Supporting evidence 1 (deprecated, use evidence array)
  evidence_2      String?  // Supporting evidence 2 (deprecated, use evidence array)
  evidence         Json?    @default("[]") // Array of evidence strings: ["evidence1", "evidence2", ...]
  is_submitted    Boolean  @default(false) // Whether stance is finalized
  is_online       Boolean  @default(false)
  last_active_at  DateTime @default(now()) @db.Timestamptz(6)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  confusion_note  String?  // Student's confusion/question
  needs_help      Boolean  @default(false)
  session         discussion_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)
  messages        discussion_messages[]
  instructor_notes discussion_instructor_notes[]

  @@unique([session_id, student_id])
  @@index([session_id], map: "idx_discussion_participants_session_id")
  @@index([student_id], map: "idx_discussion_participants_student_id")
  @@index([stance], map: "idx_discussion_participants_stance")
}

/// Messages in a discussion session (AI chat + instructor interventions)
model discussion_messages {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id      String   @db.Uuid
  participant_id  String?  @db.Uuid // null for system/instructor messages
  role            String   // "user" | "ai" | "instructor" | "system"
  content         String
  message_type    String?  // "question" | "answer" | "nudge" | "evidence_request" | etc.
  is_visible_to_student Boolean @default(true) // false = AI-only instruction
  response_id     String?  // OpenAI Responses API response ID for chaining conversations
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  metadata        Json?    @default("{}") // Additional metadata
  session         discussion_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)
  participant     discussion_participants? @relation(fields: [participant_id], references: [id], onDelete: Cascade)

  @@index([session_id], map: "idx_discussion_messages_session_id")
  @@index([participant_id], map: "idx_discussion_messages_participant_id")
  @@index([created_at], map: "idx_discussion_messages_created_at")
}

/// Pinned quotes by instructor for class presentation
model discussion_pinned_quotes {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id      String   @db.Uuid
  participant_id  String?  @db.Uuid // Original author (null if anonymous hidden)
  content         String   // The quoted text
  display_name    String?  // Display name at time of pinning
  pinned_at       DateTime @default(now()) @db.Timestamptz(6)
  sort_order      Int      @default(0)
  session         discussion_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id], map: "idx_discussion_pinned_quotes_session_id")
}

/// Instructor's private notes about a participant
model discussion_instructor_notes {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  participant_id  String   @db.Uuid
  note            String
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  participant     discussion_participants @relation(fields: [participant_id], references: [id], onDelete: Cascade)

  @@index([participant_id], map: "idx_discussion_instructor_notes_participant_id")
}
