generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// User profiles for authentication
model profiles {
  id             String    @id @db.Uuid
  email          String
  name           String
  role           String
  student_number String?
  school         String?
  department     String?
  avatar_url     String?
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([role], map: "idx_profiles_role")
}

/// Discussion session for class debates
model discussion_sessions {
  id            String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instructor_id String
  title         String
  description   String?
  status        String                     @default("draft")
  join_code     String                     @unique
  settings      Json                       @default("{}")
  created_at    DateTime                   @default(now()) @db.Timestamptz(6)
  updated_at    DateTime                   @default(now()) @db.Timestamptz(6)
  closed_at     DateTime?                  @db.Timestamptz(6)
  messages      discussion_messages[]
  participants  discussion_participants[]
  pinned_quotes discussion_pinned_quotes[]

  @@index([instructor_id], map: "idx_discussion_sessions_instructor_id")
  @@index([join_code], map: "idx_discussion_sessions_join_code")
  @@index([status], map: "idx_discussion_sessions_status")
}

/// Participants in a discussion session
model discussion_participants {
  id               String                        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id       String                        @db.Uuid
  student_id       String
  display_name     String?
  stance           String?
  stance_statement String?
  evidence_1       String?
  evidence_2       String?
  is_submitted     Boolean                       @default(false)
  is_online        Boolean                       @default(false)
  last_active_at   DateTime                      @default(now()) @db.Timestamptz(6)
  created_at       DateTime                      @default(now()) @db.Timestamptz(6)
  updated_at       DateTime                      @default(now()) @db.Timestamptz(6)
  confusion_note   String?
  needs_help       Boolean                       @default(false)
  evidence         Json?                         @default("[]")
  instructor_notes discussion_instructor_notes[]
  messages         discussion_messages[]
  session          discussion_sessions           @relation(fields: [session_id], references: [id], onDelete: Cascade)
  likes            discussion_likes[]
  comments         discussion_comments[]

  @@unique([session_id, student_id])
  @@index([session_id], map: "idx_discussion_participants_session_id")
  @@index([student_id], map: "idx_discussion_participants_student_id")
  @@index([stance], map: "idx_discussion_participants_stance")
}

/// Messages in a discussion session (AI chat + instructor interventions)
model discussion_messages {
  id                    String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id            String                   @db.Uuid
  participant_id        String?                  @db.Uuid
  role                  String
  content               String
  message_type          String?
  is_visible_to_student Boolean                  @default(true)
  response_id           String?
  created_at            DateTime                 @default(now()) @db.Timestamptz(6)
  metadata              Json?                    @default("{}")
  participant           discussion_participants? @relation(fields: [participant_id], references: [id], onDelete: Cascade)
  session               discussion_sessions      @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id], map: "idx_discussion_messages_session_id")
  @@index([participant_id], map: "idx_discussion_messages_participant_id")
  @@index([created_at], map: "idx_discussion_messages_created_at")
}

/// Pinned quotes by instructor for class presentation
model discussion_pinned_quotes {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id     String              @db.Uuid
  participant_id String?             @db.Uuid
  content        String
  display_name   String?
  pinned_at      DateTime            @default(now()) @db.Timestamptz(6)
  sort_order     Int                 @default(0)
  session        discussion_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id], map: "idx_discussion_pinned_quotes_session_id")
}

/// Instructor's private notes about a participant
model discussion_instructor_notes {
  id             String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  participant_id String                  @db.Uuid
  note           String
  created_at     DateTime                @default(now()) @db.Timestamptz(6)
  updated_at     DateTime                @default(now()) @db.Timestamptz(6)
  participant    discussion_participants @relation(fields: [participant_id], references: [id], onDelete: Cascade)

  @@index([participant_id], map: "idx_discussion_instructor_notes_participant_id")
}

/// Likes on discussion participant submissions
model discussion_likes {
  id             String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  participant_id String                  @db.Uuid
  user_id        String
  created_at     DateTime                @default(now()) @db.Timestamptz(6)
  participant    discussion_participants @relation(fields: [participant_id], references: [id], onDelete: Cascade)

  @@unique([participant_id, user_id])
  @@index([participant_id], map: "idx_discussion_likes_participant_id")
}

/// Comments on discussion participant submissions
model discussion_comments {
  id             String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  participant_id String                  @db.Uuid
  user_id        String
  user_name      String?
  content        String
  created_at     DateTime                @default(now()) @db.Timestamptz(6)
  participant    discussion_participants @relation(fields: [participant_id], references: [id], onDelete: Cascade)

  @@index([participant_id], map: "idx_discussion_comments_participant_id")
}

model exam_nodes {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instructor_id    String
  parent_id        String?      @db.Uuid
  kind             String
  name             String
  sort_order       Int          @default(0)
  exam_id          String?      @db.Uuid
  created_at       DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?    @default(now()) @db.Timestamptz(6)
  exams            exams?       @relation(fields: [exam_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  exam_nodes       exam_nodes?  @relation("exam_nodesToexam_nodes", fields: [parent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  other_exam_nodes exam_nodes[] @relation("exam_nodesToexam_nodes")

  @@index([exam_id], map: "idx_exam_nodes_exam_id")
  @@index([instructor_id], map: "idx_exam_nodes_instructor_id")
  @@index([kind], map: "idx_exam_nodes_kind")
  @@index([parent_id], map: "idx_exam_nodes_parent_id")
  @@index([parent_id, sort_order], map: "idx_exam_nodes_sort_order")
}

model exams {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  code          String       @unique
  description   String?
  duration      Int
  questions     Json
  status        String?      @default("draft")
  instructor_id String
  student_count Int?         @default(0)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?    @default(now()) @db.Timestamptz(6)
  materials     Json?        @default("[]")
  rubric        Json?        @default("[]")
  exam_nodes    exam_nodes[]

  @@index([code], map: "idx_exams_code")
  @@index([instructor_id], map: "idx_exams_instructor_id")
  @@index([rubric], map: "idx_exams_rubric", type: Gin)
}

model grades {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id    String   @db.Uuid
  q_idx         Int
  score         Int
  comment       String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  stage_grading Json?
  sessions      sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model messages {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id           String   @db.Uuid
  q_idx                Int
  role                 String
  content              String
  created_at           DateTime @default(now()) @db.Timestamptz(6)
  compressed_content   String?
  compression_metadata Json?    @default("{}")
  response_id          String?
  message_type         String?
  tokens_used          Int?
  metadata             Json?    @default("{}")
  sessions             sessions @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model questions {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exam_id    String   @db.Uuid
  idx        Int
  type       String
  prompt     String
  ai_context String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
}

model sessions {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exam_id                 String        @db.Uuid
  student_id              String
  used_clarifications     Int           @default(0)
  created_at              DateTime      @default(now()) @db.Timestamptz(6)
  submitted_at            DateTime?     @db.Timestamptz(6)
  compressed_session_data String?
  compression_metadata    Json?         @default("{}")
  ai_summary              Json?
  grades                  grades[]
  messages                messages[]
  submissions             submissions[]
}

model student_profiles {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id     String   @unique
  name           String
  student_number String
  school         String
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @default(now()) @db.Timestamptz(6)

  @@index([student_id], map: "idx_student_profiles_student_id")
}

model submissions {
  id                       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id               String    @db.Uuid
  q_idx                    Int
  answer                   String
  ai_feedback              Json?
  student_reply            String?
  created_at               DateTime  @default(now()) @db.Timestamptz(6)
  updated_at               DateTime? @default(now()) @db.Timestamptz(6)
  answer_history           Json?     @default("[]")
  edit_count               Int?      @default(0)
  compressed_answer_data   String?
  compressed_feedback_data String?
  compression_metadata     Json?     @default("{}")
  sessions                 sessions  @relation(fields: [session_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// Universities cache
model universities {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  campus      String?
  type        String?
  location    String?
  link        String?
  updated_at  DateTime      @default(now()) @db.Timestamptz(6)
  
  departments departments[]

  @@unique([name, campus])
  @@index([name], map: "idx_universities_name")
}

/// Departments cache (Majors)
model departments {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  university_id String       @db.Uuid
  name          String
  updated_at    DateTime     @default(now()) @db.Timestamptz(6)

  university    universities @relation(fields: [university_id], references: [id], onDelete: Cascade)

  @@unique([university_id, name])
  @@index([university_id], map: "idx_departments_university_id")
  @@index([name], map: "idx_departments_name")
}
